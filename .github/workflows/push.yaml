name: Mod Release & Downstream Sync
concurrency: Push-pipeline
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      manual_bump:
        description: 'Override bump (patch, minor, major)'
        default: 'patch'
        type: choice
        options: [patch, minor, major]

env:
  pack-file: "pack.toml"
  mod_name: "Prepare to Dye Plus"
  mod_id: "ptdyeplus"
  mod_slug: "ptdye-plus"
  loader: "forge"
  mc_version: "1.20.1"
  target_modpack_repo: "game-design-driven/Create-Prepare-to-Dye-2"

jobs:
  # Validation
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: validate JSON and YAML files
        uses: GrantBirki/json-yaml-validate@v2.4.0
  # Versioning
  tag_and_release:
    needs: [ tests ]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          tag_prefix: ""
          default_bump: ${{ github.event.inputs.manual_bump || 'patch' }}
          custom_release_rules: |
            feat:minor:Features,
            overhaul:minor:Overhaul,
            fix:patch:Bug fixes,
            refactor:patch:Refactor,
            chore:patch:Maintenance,
            docs:patch:Documentation,
            test:patch:Testing,
            ci:patch:Continuous Integration,
            revert:patch:Reverted Changes
          github_token: ${{ secrets.GITHUB_TOKEN }}
  # Build mod
  build:
    needs: [ tag_and_release ]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      jar_name: ${{ steps.share_info.outputs.jar_name }}
    steps:
      - uses: actions/checkout@v4
      - name: Update version files
        run: |
          chmod +x ./update_version.sh
          ./update_version.sh ${{ needs.tag_and_release.outputs.new_tag }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.8
          cache-read-only: false
      
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew build

      - name: Capture Jar Name
        id: share_info
        run: |
          shopt -s extglob
          JAR=$(ls build/libs/!(*-all|*-sources|*-javadoc).jar | xargs basename)
          echo "jar_name=$JAR" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-jar
          path: build/libs/*.jar

      - name: Commit version bump back to repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(version): update to ${{ needs.tag_and_release.outputs.new_tag }} [skip ci]"
          branch: main
  # Publish to all platforms
  publish:
    needs: [ tag_and_release, build ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download built jar
        uses: actions/download-artifact@v4
        with:
          name: built-jar
          path: build/libs

      - name: Publish to All Platforms
        uses: Kir-Antipov/mc-publish@v3.3.0
        with:
          modrinth-id: ${{  vars.MODRINTH_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: ${{ vars.CF_ID }}
          curseforge-token: ${{ secrets.CF_API_TOKEN }}

          loaders: ${{ env.loader }}
          game-versions: ${{ env.mc_version }}
          files: "build/libs/!(*-all|*-sources|*-javadoc).jar"
          name: "${{ env.mod_id }}-${{ needs.tag_and_release.outputs.new_tag }}+${{ env.loader}}-${{ env.mc_version }}"
          version: ${{ needs.tag_and_release.outputs.new_tag }}
          version-type: release
          changelog: ${{ needs.tag_and_release.outputs.changelog }}
  # Modpack PR
  make_pr_for_modpack:
    needs: [ publish, tag_and_release ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Modpack
        uses: actions/checkout@v4
        with:
          repository: ${{ env.target_modpack_repo }}
          token: ${{ secrets.GH_TOKEN }}
          ref: main

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.19'

      - name: Install packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          sudo cp $(go env GOPATH)/bin/packwiz /usr/local/bin/

      - name: Create Polling script
        run: |
          cat << 'EOF' > poll_update.sh
          #!/bin/bash
          TARGET_DIR=$1
          MAX_RETRIES=20
          RETRY_INTERVAL=60

          echo "Attempting to update modpack using packwiz in '$TARGET_DIR'..."

          if [ -n "$TARGET_DIR" ] && [ "$TARGET_DIR" != "." ]; then
            cd "$TARGET_DIR" || exit 1
          fi

          for ((i=1; i<=MAX_RETRIES; i++)); do
            if packwiz update "${{ env.mod_slug }}"; then
              echo "Success: Update found and applied for ${{ env.mod_id}} (${{ env.mod_slug }})."
              exit 0
            fi

            echo "Attempt $i/$MAX_RETRIES: No update found yet. Sleeping ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done

          echo "Error: Timed out waiting for ${{ env.mod_id }} (${{ env.mod_slug }}) update after $((MAX_RETRIES * RETRY_INTERVAL / 60)) minutes."
          exit 1
          EOF
          chmod +x ./poll_update.sh

      - name: Update Modrinth Modpack
        run: ./poll_update.sh "."

      - name: Update Curseforge Modpack
        run: ./poll_update.sh "./curseforge"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "mods: update ${{ env.mod_name }} to ${{ needs.tag_and_release.outputs.new_tag }}"
          title: "Update ${{ env.mod_name }} to ${{ needs.tag_and_release.outputs.new_tag }}"
          branch: "update/${{ env.mod_id }}"
          add-paths: |
            "${{ env.pack-file }}"
            "mods/${{ env.mod_slug }}.toml"
            "curseforge/${{ env.pack-file }}"
            "curseforge/mods/${{ env.mod_slug }}.toml"
          body: |
            ## Mod Update: ${{ env.mod_name }}
            - **New Version**: `${{ needs.tag_and_release.outputs.new_tag }}`
            - **Target MC:**: `${{ env.mc_version }}`
            - **Loader**: `${{ env.loader }}`

            ## Changelog
            ${{ needs.tag_and_release.outputs.changelog }}

            ---
            *This PR was automatically generated by the ${{ github.workflow }} pipeline.*
